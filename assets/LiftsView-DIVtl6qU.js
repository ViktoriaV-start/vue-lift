import{_ as O,u as w,r as R,a as T,w as j,o as U,b as C,c as v,d as F,e as y,t as G,f as g,U as V,D as W,F as Q,g as M,n as Y,G as D,L as z,h as N}from"./index-D-9LnoiO.js";const H=!1,J={__name:"LiftInGroup",props:["levels","liftId"],setup(_,{expose:a}){const u=w(),{levels:f,liftId:c}=_;let e=R({...u.value.getGroupLiftState(c)});a({addFloor:o,setParams:r,liftId:c,lift:e,saveQueueToLocalStorage:A,run:t});const s=T(null),d=T(null);let p=null;const l=[];let m=null,L=T(!0);function t(){const n=()=>{e.destination=l[0],e.currentFloor<l[0]?(e.progress=Math.abs(e.progress),e.movement=V):(e.progress=Math.abs(e.progress)*-1,e.movement=W),x(l[0])};e.isRun?L.value&&e.isRun&&(l.push(e.destination),L.value=!1,x(l[0])):(e.isRun=!0,L.value=!1,n())}function o(n){const i=()=>{l.push(n),t()};e.isRun?e.isRun&&i():i()}function r(){p=d.value,p.style.bottom=e.bottom+"px",p.style.left=(c-1)*100+(c-1)*20+1+"px",l.length&&e.isRun&&t()}const b=(n,i,I)=>{n>I?e.bottom=f[e.destination]:e.movement==="DOWN"?e.bottom=i-n/10:e.bottom=i+n/10,d.value.style.bottom=e.bottom+"px"},h=()=>new Promise(n=>{m=setTimeout(n,3e3)}).catch(n=>console.log(n)),x=n=>{e.currentFloor=n;let i=performance.now();const I=e.bottom,P=Math.abs(e.bottom-f[n])*10;s.value=requestAnimationFrame(function q(k){k<i&&(i=k-1);let B=k-i;if(e.bottom<-5||e.bottom>Object.values(f).at(-1)+5)throw new Error("КОСЯК!");if(s.value&&e.bottom!==f[n])p&&b(B,I,P),requestAnimationFrame(q);else if(s.value){cancelAnimationFrame(s.value),p.classList.add("blink"),s.value=null;let E=[...u.value.getLiftQueue(H)].filter($=>$!=n);A(E),l.shift(),h().then(()=>{e.isRun=!1,p.classList.remove("blink"),l.length&&t()})}})};j(e,()=>{u.value.setGroupLiftState({...e})});function A(n){const i=[];for(let I in n)i.push(n[I]);u.value.setGroupLiftQueue(i)}return U(()=>console.log("MOUNTED LIFT: ",e.id)),C(()=>{clearTimeout(m)}),(n,i)=>(v(),F("div",{class:"lift",ref_key:"liftRef",ref:d},[y("div",null,G(g(e).isRun?g(e).destination:""),1),y("div",null,G(g(e).isRun?g(e).movement:""),1)],512))}},K=O(J,[["__scopeId","data-v-cf8f25f3"]]),X={class:"floor"},Z=["tube-number"],ee=!1,te={__name:"FloorInGroup",props:["el","add","liftsRange"],setup(_){const a=w(),{el:u,add:f,liftsRange:c}=_,e=T(u),s=()=>!!Object.values(a.value.groupLiftState).find(m=>m.destination===e.value),d=()=>{f(e.value)};return(p,l)=>(v(),F("div",X,[(v(!0),F(Q,null,M(_.liftsRange,m=>(v(),F("div",{key:m,"tube-number":m,class:"space"},null,8,Z))),128)),y("button",{class:Y(["btn",g(a).getLiftQueue(ee).includes(e.value)?s()?"destination":"pressed":""]),type:"button",onClick:d},G(e.value),3)]))}},se=O(te,[["__scopeId","data-v-9f891408"]]);function ne(){const _=R([]),a=R({}),u=R([]),f=()=>{for(let s=D;s>0;s--)_.push(s)},c=()=>{for(let s=1;s<=D;s++)a[s]=s*100-100},e=()=>{for(let s=1;s<=z;s++)u.push(s)};return f(),c(),e(),[_,a,u]}const oe={class:"lifts-container"},S=!1,le={__name:"LiftsView",setup(_){const a=w();a.value.checkGroupLocalStorage();const[u,f,c]=ne(),e=R([]);let s=null,d=R([]);const p=t=>{if(d.find(o=>o[1].lift.currentFloor===t))return!0},l=t=>{if(!a.value.getLiftQueue(S).includes(t)){let o=[...a.value.getLiftQueue(S)];o.push(t),d[0][1].saveQueueToLocalStorage(o)}},m=t=>{let o=d.filter(b=>!b[1].lift.isRun),r=[];return o.length&&(r=o.reduce((b,h)=>Math.abs(t-h[1].lift.currentFloor)-Math.abs(t-b[1].lift.currentFloor)===0&&!h[1].lift.isRun?h[1].lift.currentFloor>t?h:b:Math.abs(t-h[1].lift.currentFloor)-Math.abs(t-b[1].lift.currentFloor)>0&&!h[1].lift.isRun?b:h,o[0])),r},L=t=>{if(!p(t)){l(t);let r=m(t);r.length?r[1].addFloor(t):s=setTimeout(()=>L(t),500)}};return U(()=>{e.forEach(o=>{o.setParams(),o.lift.isRun&&o.run()}),d=Object.entries(e);let t=a.value.getLiftQueue(S);if(t.length)for(let o in t)L(t[o]);console.log("MOUNTED in App")}),C(()=>{clearTimeout(s)}),(t,o)=>(v(),F("section",oe,[(v(!0),F(Q,null,M(g(u),r=>(v(),N(se,{key:r,el:r,liftsRange:g(c),add:L},null,8,["el","liftsRange"]))),128)),(v(!0),F(Q,null,M(g(c),r=>(v(),N(K,{key:r,liftId:r,levels:g(f),ref_for:!0,ref:"liftComponentRef"},null,8,["liftId","levels"]))),128))]))}},ie=O(le,[["__scopeId","data-v-ed8fc7a0"]]);export{ie as default};
